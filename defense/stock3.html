<!DOCTYPE html>

<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¯¸êµ­ ì£¼ì‹ ì‹œì¥ ë§µ - ì‹¤ì‹œê°„ ë°ì´í„°</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: #fff;
        padding: 20px;
    }

    .header {
        text-align: center;
        margin-bottom: 30px;
    }

    h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .subtitle {
        color: #8892b0;
        font-size: 1.1em;
    }

    .info-box {
        margin-top: 10px;
        padding: 10px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 8px;
        font-size: 0.9em;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }

    .controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .control-btn {
        padding: 10px 20px;
        background: rgba(102, 126, 234, 0.2);
        border: 2px solid #667eea;
        color: #fff;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .control-btn:hover {
        background: rgba(102, 126, 234, 0.4);
        transform: translateY(-2px);
    }

    .control-btn.active {
        background: #667eea;
    }

    #chart-container {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
    }

    .loading {
        text-align: center;
        padding: 100px;
        font-size: 1.2em;
        color: #667eea;
    }

    .spinner {
        border: 4px solid rgba(102, 126, 234, 0.2);
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .progress {
        margin-top: 20px;
        font-size: 0.9em;
        color: #8892b0;
    }

    .cell {
        cursor: pointer;
        transition: opacity 0.3s ease;
    }

    .cell:hover {
        opacity: 0.8;
        stroke: #fff;
        stroke-width: 3;
    }

    .cell-label {
        pointer-events: none;
        font-weight: 600;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }

    .tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.95);
        color: #fff;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 13px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
        border: 1px solid #667eea;
        z-index: 1000;
        max-width: 320px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    .tooltip.show {
        opacity: 1;
    }

    .stats {
        display: flex;
        justify-content: center;
        gap: 40px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #667eea;
    }

    .stat-label {
        color: #8892b0;
        font-size: 0.9em;
        margin-top: 5px;
    }

    .last-update {
        text-align: center;
        color: #8892b0;
        font-size: 0.9em;
        margin-top: 15px;
    }

    .error-message {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid #ef4444;
        color: #fca5a5;
        padding: 15px;
        border-radius: 8px;
        margin: 20px;
    }
</style>
```

</head>
<body>
    <div class="header">
        <h1>ğŸ‡ºğŸ‡¸ US Stock Market Map</h1>
        <div class="subtitle">ì‹¤ì‹œê°„ ì£¼ì‹ ë°ì´í„° Tree Map</div>
        <div class="info-box">
            ğŸ’¡ <strong>ì‹¤ì‹œê°„ ë°ì´í„°:</strong> 
            Yahoo Finance APIë¥¼ í†µí•´ ì‹¤ì œ ì‹œì„¸, ì‹œê°€ì´ì•¡, ê±°ë˜ëŸ‰ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. 
            CORS ìš°íšŒë¥¼ ìœ„í•´ í”„ë¡ì‹œ ì„œë²„ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        </div>
    </div>

```
<div class="controls">
    <button class="control-btn active" onclick="updateView('marketCap')">ì‹œê°€ì´ì•¡</button>
    <button class="control-btn" onclick="updateView('change')">ë“±ë½ë¥ </button>
    <button class="control-btn" onclick="updateView('volume')">ê±°ë˜ëŸ‰</button>
    <button class="control-btn" onclick="refreshData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
</div>

<div id="chart-container">
    <div class="loading" id="loading">
        <div class="spinner"></div>
        ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë”© ì¤‘...
        <div class="progress" id="progress"></div>
    </div>
    <div id="chart"></div>
</div>

<div class="stats" id="stats"></div>
<div class="last-update" id="last-update"></div>

<div class="tooltip" id="tooltip"></div>

<script>
    let currentView = 'marketCap';
    let stockData = [];

    // ì£¼ìš” ë¯¸êµ­ ê¸°ì—… ë°ì´í„° (ì„¹í„°ë³„ ëŒ€í‘œ ê¸°ì—…ë“¤)
    const companies = {
        'Technology': [
            { symbol: 'AAPL', name: 'Apple Inc.' },
            { symbol: 'MSFT', name: 'Microsoft Corporation' },
            { symbol: 'GOOGL', name: 'Alphabet Inc.' },
            { symbol: 'META', name: 'Meta Platforms Inc.' },
            { symbol: 'NVDA', name: 'NVIDIA Corporation' },
            { symbol: 'TSLA', name: 'Tesla Inc.' },
            { symbol: 'AVGO', name: 'Broadcom Inc.' },
            { symbol: 'ORCL', name: 'Oracle Corporation' },
            { symbol: 'ADBE', name: 'Adobe Inc.' },
            { symbol: 'CRM', name: 'Salesforce Inc.' }
        ],
        'Healthcare': [
            { symbol: 'UNH', name: 'UnitedHealth Group' },
            { symbol: 'JNJ', name: 'Johnson & Johnson' },
            { symbol: 'LLY', name: 'Eli Lilly and Company' },
            { symbol: 'ABBV', name: 'AbbVie Inc.' },
            { symbol: 'MRK', name: 'Merck & Co.' },
            { symbol: 'PFE', name: 'Pfizer Inc.' }
        ],
        'Financials': [
            { symbol: 'BRK-B', name: 'Berkshire Hathaway' },
            { symbol: 'JPM', name: 'JPMorgan Chase & Co.' },
            { symbol: 'V', name: 'Visa Inc.' },
            { symbol: 'MA', name: 'Mastercard Inc.' },
            { symbol: 'BAC', name: 'Bank of America Corp.' },
            { symbol: 'WFC', name: 'Wells Fargo & Company' }
        ],
        'Consumer': [
            { symbol: 'AMZN', name: 'Amazon.com Inc.' },
            { symbol: 'WMT', name: 'Walmart Inc.' },
            { symbol: 'HD', name: 'The Home Depot Inc.' },
            { symbol: 'MCD', name: "McDonald's Corporation" },
            { symbol: 'NKE', name: 'NIKE Inc.' },
            { symbol: 'COST', name: 'Costco Wholesale Corp.' }
        ],
        'Energy': [
            { symbol: 'XOM', name: 'Exxon Mobil Corporation' },
            { symbol: 'CVX', name: 'Chevron Corporation' },
            { symbol: 'COP', name: 'ConocoPhillips' },
            { symbol: 'SLB', name: 'Schlumberger Limited' }
        ],
        'Industrials': [
            { symbol: 'BA', name: 'The Boeing Company' },
            { symbol: 'UPS', name: 'United Parcel Service' },
            { symbol: 'HON', name: 'Honeywell International' },
            { symbol: 'CAT', name: 'Caterpillar Inc.' }
        ],
        'Communication': [
            { symbol: 'NFLX', name: 'Netflix Inc.' },
            { symbol: 'DIS', name: 'The Walt Disney Company' },
            { symbol: 'CMCSA', name: 'Comcast Corporation' },
            { symbol: 'T', name: 'AT&T Inc.' }
        ]
    };

    // ìƒ‰ìƒ ìŠ¤ì¼€ì¼
    const sectorColors = {
        'Technology': '#667eea',
        'Healthcare': '#f093fb',
        'Financials': '#4facfe',
        'Consumer': '#43e97b',
        'Energy': '#fa709a',
        'Industrials': '#feca57',
        'Communication': '#ff6b6b'
    };

    // Yahoo Finance APIë¥¼ í†µí•œ ì‹¤ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async function fetchStockData() {
        const loading = document.getElementById('loading');
        const chart = document.getElementById('chart');
        const progress = document.getElementById('progress');
        loading.style.display = 'block';
        chart.innerHTML = '';
        
        stockData = [];
        let totalStocks = 0;
        let processedStocks = 0;
        
        // ì „ì²´ ì£¼ì‹ ìˆ˜ ê³„ì‚°
        for (const stocks of Object.values(companies)) {
            totalStocks += stocks.length;
        }
        
        for (const [sector, stocks] of Object.entries(companies)) {
            for (const stock of stocks) {
                try {
                    const data = await fetchYahooFinanceData(stock.symbol, stock.name, sector);
                    if (data) {
                        stockData.push(data);
                    }
                    processedStocks++;
                    progress.textContent = `${processedStocks}/${totalStocks} ì¢…ëª© ë¡œë”© ì™„ë£Œ`;
                    
                    // API í˜¸ì¶œ ì œí•œ ë°©ì§€
                    await sleep(100);
                } catch (error) {
                    console.error(`Error fetching ${stock.symbol}:`, error);
                    processedStocks++;
                }
            }
        }
        
        console.log(`ë°ì´í„° ë¡œë”© ì™„ë£Œ: ${stockData.length}ê°œ ì¢…ëª©`);
        
        loading.style.display = 'none';
        
        if (stockData.length > 0) {
            renderChart();
            updateStats();
        } else {
            loading.innerHTML = '<div class="error-message">âš ï¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>';
            loading.style.display = 'block';
        }
    }

    // Yahoo Finance ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (CORS ìš°íšŒ í”„ë¡ì‹œ ì‚¬ìš©)
    async function fetchYahooFinanceData(symbol, name, sector) {
        try {
            // ì—¬ëŸ¬ í”„ë¡ì‹œ ì˜µì…˜
            const proxies = [
                `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`,
                `https://query2.finance.yahoo.com/v8/finance/chart/${symbol}`
            ];
            
            let data = null;
            
            for (const proxyUrl of proxies) {
                try {
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) {
                        continue;
                    }
                    
                    const result = await response.json();
                    
                    if (result.chart && result.chart.result && result.chart.result[0]) {
                        const chartData = result.chart.result[0];
                        const meta = chartData.meta;
                        const quote = chartData.indicators.quote[0];
                        
                        const currentPrice = meta.regularMarketPrice || meta.previousClose;
                        const previousClose = meta.chartPreviousClose || meta.previousClose;
                        const change = ((currentPrice - previousClose) / previousClose) * 100;
                        
                        data = {
                            symbol: symbol,
                            name: name,
                            sector: sector,
                            price: currentPrice,
                            previousClose: previousClose,
                            change: change,
                            changeAbs: currentPrice - previousClose,
                            marketCap: meta.marketCap || 100000000000,
                            volume: meta.regularMarketVolume || 0,
                            high: meta.regularMarketDayHigh || currentPrice,
                            low: meta.regularMarketDayLow || currentPrice,
                            open: meta.regularMarketOpen || currentPrice,
                            fiftyTwoWeekHigh: meta.fiftyTwoWeekHigh || currentPrice,
                            fiftyTwoWeekLow: meta.fiftyTwoWeekLow || currentPrice
                        };
                        
                        break;
                    }
                } catch (e) {
                    console.error(`Proxy failed for ${symbol}:`, e);
                    continue;
                }
            }
            
            return data;
        } catch (error) {
            console.error(`Error fetching Yahoo Finance data for ${symbol}:`, error);
            return null;
        }
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function renderChart() {
        const container = document.getElementById('chart');
        container.innerHTML = '';

        const width = Math.min(1400, window.innerWidth - 80);
        const height = 700;

        // ë°ì´í„° êµ¬ì¡°í™”
        const hierarchyData = {
            name: 'US Stock Market',
            children: Object.keys(sectorColors).map(sector => ({
                name: sector,
                children: stockData
                    .filter(d => d.sector === sector)
                    .map(d => ({
                        ...d,
                        value: currentView === 'marketCap' ? d.marketCap : 
                               currentView === 'change' ? Math.abs(d.change) * 100000000 :
                               d.volume
                    }))
            }))
        };

        const root = d3.hierarchy(hierarchyData)
            .sum(d => d.value || 1)
            .sort((a, b) => b.value - a.value);

        const treemap = d3.treemap()
            .size([width, height])
            .paddingOuter(4)
            .paddingTop(25)
            .paddingInner(2)
            .round(true);

        treemap(root);

        const svg = d3.select('#chart')
            .append('svg')
            .attr('width', width)
            .attr('height', height);

        const tooltip = d3.select('#tooltip');

        // ì„¹í„° ê·¸ë£¹
        const nodes = svg.selectAll('g')
            .data(root.descendants().filter(d => d.depth === 1))
            .join('g')
            .attr('transform', d => `translate(${d.x0},${d.y0})`);

        // ì„¹í„° ë°°ê²½
        nodes.append('rect')
            .attr('width', d => d.x1 - d.x0)
            .attr('height', d => d.y1 - d.y0)
            .attr('fill', d => sectorColors[d.data.name])
            .attr('opacity', 0.1)
            .attr('rx', 8);

        // ì„¹í„° ë ˆì´ë¸”
        nodes.append('text')
            .attr('x', 8)
            .attr('y', 18)
            .attr('fill', '#fff')
            .attr('font-size', '14px')
            .attr('font-weight', 'bold')
            .text(d => d.data.name);

        // ê°œë³„ ì£¼ì‹ ì…€
        const cells = svg.selectAll('.cell')
            .data(root.leaves())
            .join('g')
            .attr('class', 'cell')
            .attr('transform', d => `translate(${d.x0},${d.y0})`);

        cells.append('rect')
            .attr('width', d => Math.max(0, d.x1 - d.x0))
            .attr('height', d => Math.max(0, d.y1 - d.y0))
            .attr('fill', d => {
                if (currentView === 'change') {
                    return d.data.change >= 0 ? '#10b981' : '#ef4444';
                }
                return sectorColors[d.parent.data.name];
            })
            .attr('opacity', d => {
                if (currentView === 'change') {
                    return Math.min(Math.abs(d.data.change) / 5, 1) * 0.6 + 0.3;
                }
                return 0.8;
            })
            .attr('rx', 4);

        // ì£¼ì‹ ì‹¬ë³¼ í…ìŠ¤íŠ¸
        cells.append('text')
            .attr('class', 'cell-label')
            .attr('x', d => (d.x1 - d.x0) / 2)
            .attr('y', d => (d.y1 - d.y0) / 2 - 5)
            .attr('text-anchor', 'middle')
            .attr('fill', '#fff')
            .attr('font-size', d => {
                const width = d.x1 - d.x0;
                return Math.min(width / 4, 16) + 'px';
            })
            .text(d => d.data.symbol);

        // ê°€ê²©/ë³€ë™ë¥ /ê±°ë˜ëŸ‰ í…ìŠ¤íŠ¸
        cells.append('text')
            .attr('class', 'cell-label')
            .attr('x', d => (d.x1 - d.x0) / 2)
            .attr('y', d => (d.y1 - d.y0) / 2 + 12)
            .attr('text-anchor', 'middle')
            .attr('fill', '#fff')
            .attr('font-size', d => {
                const width = d.x1 - d.x0;
                return Math.min(width / 6, 12) + 'px';
            })
            .text(d => {
                if (currentView === 'change') {
                    return `${d.data.change >= 0 ? '+' : ''}${d.data.change.toFixed(2)}%`;
                } else if (currentView === 'volume') {
                    return `${(d.data.volume / 1e6).toFixed(1)}M`;
                }
                return `$${d.data.price.toFixed(2)}`;
            });

        // íˆ´íŒ ì´ë²¤íŠ¸
        cells.on('mouseover', function(event, d) {
            const changeColor = d.data.change >= 0 ? '#10b981' : '#ef4444';
            
            tooltip.html(`
                <strong style="font-size: 14px;">${d.data.name}</strong><br/>
                <span style="color: #8892b0;">${d.data.symbol} â€¢ ${d.parent.data.name}</span><br/>
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(136, 146, 176, 0.3);">
                <strong>í˜„ì¬ê°€:</strong> $${d.data.price.toFixed(2)}<br/>
                <strong>ì „ì¼ì¢…ê°€:</strong> $${d.data.previousClose.toFixed(2)}<br/>
                <strong>ë³€ë™:</strong> <span style="color: ${changeColor}">${d.data.change >= 0 ? '+' : ''}${d.data.change.toFixed(2)}% ($${d.data.changeAbs >= 0 ? '+' : ''}${d.data.changeAbs.toFixed(2)})</span><br/>
                <strong>ì‹œê°€ì´ì•¡:</strong> $${formatLargeNumber(d.data.marketCap)}<br/>
                <strong>ê±°ë˜ëŸ‰:</strong> ${formatLargeNumber(d.data.volume)}<br/>
                <strong>ë‹¹ì¼ ê³ ê°€/ì €ê°€:</strong> $${d.data.high.toFixed(2)} / $${d.data.low.toFixed(2)}<br/>
                <strong>52ì£¼ ê³ ê°€/ì €ê°€:</strong> $${d.data.fiftyTwoWeekHigh.toFixed(2)} / $${d.data.fiftyTwoWeekLow.toFixed(2)}
                </div>
            `)
                .classed('show', true)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        })
        .on('mouseout', function() {
            tooltip.classed('show', false);
        });
    }

    function formatLargeNumber(num) {
        if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
        if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
        if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
        if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
        return num.toFixed(0);
    }

    function updateStats() {
        const totalMarketCap = stockData.reduce((sum, d) => sum + d.marketCap, 0);
        const avgChange = stockData.reduce((sum, d) => sum + d.change, 0) / stockData.length;
        const gainers = stockData.filter(d => d.change > 0).length;
        const losers = stockData.filter(d => d.change < 0).length;

        const statsHtml = `
            <div class="stat-item">
                <div class="stat-value">$${(totalMarketCap / 1e12).toFixed(2)}T</div>
                <div class="stat-label">ì´ ì‹œê°€ì´ì•¡</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="color: ${avgChange >= 0 ? '#10b981' : '#ef4444'}">
                    ${avgChange >= 0 ? '+' : ''}${avgChange.toFixed(2)}%
                </div>
                <div class="stat-label">í‰ê·  ë“±ë½ë¥ </div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="color: #10b981">${gainers}</div>
                <div class="stat-label">ìƒìŠ¹ ì¢…ëª©</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="color: #ef4444">${losers}</div>
                <div class="stat-label">í•˜ë½ ì¢…ëª©</div>
            </div>
        `;

        document.getElementById('stats').innerHTML = statsHtml;
        document.getElementById('last-update').innerHTML = 
            `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString('ko-KR')} â€¢ Powered by Yahoo Finance`;
    }

    function updateView(view) {
        currentView = view;
        document.querySelectorAll('.control-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        renderChart();
    }

    function refreshData() {
        fetchStockData();
    }

    // ì´ˆê¸° ë¡œë“œ
    window.addEventListener('load', () => {
        fetchStockData();
    });

    // ë°˜ì‘í˜• ì²˜ë¦¬
    window.addEventListener('resize', () => {
        if (stockData.length > 0) {
            renderChart();
        }
    });
</script>
```

</body>
</html>